name: Analyse de code avec SonarQube

on:
  push:
    branches:
      - main
      - master
  pull_request:

jobs:
  sonarqube_scan:
    name: Analyse statique SonarQube
    runs-on: ubuntu-latest

    steps:
      # √âtape 1 : R√©cup√©ration du code
      - name: üì¶ Checkout du code
        uses: actions/checkout@v4

      # √âtape 2 : Installation de Python
      - name: üêç Installation de Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # √âtape 3 : Installation des d√©pendances
      - name: üìö Installation des d√©pendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pylint pytest pytest-cov || true

      # √âtape 4 : G√©n√©ration des rapports locaux
      - name: üß™ G√©n√©ration des rapports
        run: |
          pylint app.py models.py forms.py config.py reset_db.py > pylint-report.txt || true
          pytest --cov=./ --cov-report=xml || true

      # √âtape 5 : T√©l√©chargement et ex√©cution du scanner SonarQube
      - name: üîç Ex√©cution de SonarQube Scanner
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          export SONAR_SCANNER_VERSION=5.0.1.3006
          export SONAR_SCANNER_HOME=$HOME/.sonar/sonar-scanner-$SONAR_SCANNER_VERSION-linux
          mkdir -p $HOME/.sonar
          curl -sSLo $HOME/.sonar/sonar-scanner.zip \
            https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$SONAR_SCANNER_VERSION-linux.zip
          unzip -o $HOME/.sonar/sonar-scanner.zip -d $HOME/.sonar/
          export PATH=$SONAR_SCANNER_HOME/bin:$PATH
          sonar-scanner \
            -Dsonar.projectKey=projet_python \
            -Dsonar.sources=. \
            -Dsonar.host.url=http://192.168.1.17:9000 \
            -Dsonar.token=$SONAR_TOKEN \
            -Dsonar.python.version=3.10 \
            -Dsonar.sourceEncoding=UTF-8 \
            -Dsonar.exclusions=venv/**,__pycache__/**,*.pyc,*.txt,*.sql,static/**,templates/** \
            -Dsonar.python.coverage.reportPaths=coverage.xml \
            -Dsonar.python.pylint.reportPaths=pylint-report.txt
