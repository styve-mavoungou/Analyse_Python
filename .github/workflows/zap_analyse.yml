name: Analyse de SÃ©curitÃ© (DAST) avec OWASP ZAP

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  zap_scan:
    runs-on: ubuntu-latest

    env:
      TARGET_URL: http://127.0.0.1:5000

    steps:
      # 1ï¸âƒ£ RÃ©cupÃ©ration du dÃ©pÃ´t
      - name: â¬‡ï¸ VÃ©rification du dÃ©pÃ´t
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Installation et dÃ©marrage du serveur Flask
      - name: âš™ï¸ Configuration de l'environnement Python et lancement du serveur Flask
        run: |
          echo "ğŸš€ Installation de Python et des dÃ©pendances..."
          sudo apt update -y
          sudo apt install -y python3 python3-pip curl

          echo "ğŸ“¦ Installation des dÃ©pendances du projet..."
          pip install -r requirements.txt --break-system-packages

          echo "ğŸ§  Lancement du serveur Flask en arriÃ¨re-plan..."
          nohup python3 app.py > server.log 2>&1 &

          echo "â³ VÃ©rification du dÃ©marrage du serveur Flask..."
          # Attente de 10 tentatives (5 secondes chacune)
          for i in {1..10}; do
            if curl -s ${{ env.TARGET_URL }} > /dev/null; then
              echo "âœ… Serveur Flask est prÃªt !"
              break
            else
              echo "ğŸ”„ Tentative $i/10 : le serveur n'est pas encore prÃªt..."
              sleep 5
            fi
            if [ $i -eq 10 ]; then
              echo "âŒ Le serveur Flask n'a pas dÃ©marrÃ© aprÃ¨s 50 secondes."
              cat server.log
              exit 1
            fi
          done

      # 3ï¸âƒ£ Lancement du scan OWASP ZAP (Baseline)
      - name: ğŸ›¡ï¸ Lancement du ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: ${{ env.TARGET_URL }}
          html_report: zap_report.html
          fail_action: false  # ne fait pas Ã©chouer le pipeline mÃªme si vulnÃ©rabilitÃ©s
        continue-on-error: true

      # 4ï¸âƒ£ Affichage du rapport dans les logs
      - name: ğŸ“œ Afficher le rÃ©sumÃ© du rapport ZAP
        if: always()
        run: |
          echo "=== RAPPORT OWASP ZAP ==="
          if [ -f zap_report.html ]; then
            grep -E "<title>|<h1>|<h2>" zap_report.html || echo "Le rapport HTML a Ã©tÃ© gÃ©nÃ©rÃ© avec succÃ¨s."
          else
            echo "âš ï¸ Aucun rapport ZAP trouvÃ©."
          fi

      # 5ï¸âƒ£ Sauvegarde du rapport et des logs
      - name: ğŸ“¦ Sauvegarde du Rapport et du Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rapport-zap
          path: |
            zap_report.html
            server.log
