name: Analyse DAST avec OWASP ZAP

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    name: Scan ZAP Baseline

    steps:
      # 1. Récupération du code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Installation de Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' 

      # 3. Installation des dépendances
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. Démarrage de l'application Flask en arrière-plan
      # C'est l'étape CRUCIALE pour le DAST : l'app doit tourner pour être scannée
      - name: Start Flask Application
        run: |
          # On lance l'app en tâche de fond avec '&'
          python app.py &
          # On attend 10 secondes pour être sûr que le serveur est prêt
          sleep 10

      # 5. Lancement du scan OWASP ZAP (Baseline Scan)
      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.14.0
        with:
          target: 'http://localhost:5000'
          allow_issue_writing: false # Mettre à true pour créer des Issues GitHub automatiquement
          fail_action: true          # Fait échouer le pipeline si des failles High/Medium sont trouvées
          cmd_options: '-a'          # Inclure les règles "alpha" (optionnel)

      # 6. Sauvegarde du rapport (même si le scan échoue)
      - name: Upload ZAP Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ZAP-rapport
          path: rapport_zap.html
