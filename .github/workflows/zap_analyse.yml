name: ğŸ” Analyse DAST avec OWASP ZAP

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      target_url:
        description: "URL de la cible Flask Ã  analyser"
        required: true
        default: "http://192.168.1.17:5000"

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    env:
      TARGET_URL: ${{ github.event.inputs.target_url }}

    steps:
      - name: ğŸ“¥ RÃ©cupÃ©ration du dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: âš™ï¸ Installation de OWASP ZAP 2.16.1
        run: |
          wget https://github.com/zaproxy/zaproxy/releases/download/v2.16.1/ZAP_2.16.1_Linux.tar.gz
          tar -xvf ZAP_2.16.1_Linux.tar.gz -C /opt/
          chmod +x /opt/ZAP_2.16.1/zap.sh
          echo "âœ… ZAP installÃ© dans /opt/ZAP_2.16.1"

      - name: ğŸš€ DÃ©marrage de ZAP en mode Daemon
        run: |
          /opt/ZAP_2.16.1/zap.sh -daemon -host 0.0.0.0 -port 8090 \
            -config api.addrs.addr.name=.* \
            -config api.addrs.addr.regex=true \
            -config api.disablekey=true &
          echo "â³ Attente du dÃ©marrage de ZAP..."
          sleep 30

      - name: ğŸ Installation de Python et dÃ©pendances
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Installation des bibliothÃ¨ques Python
        run: |
          pip install python-owasp-zap-v2.4 requests

      - name: âš¡ ExÃ©cution du scan OWASP ZAP
        run: |
          echo "ğŸ” DÃ©marrage de l'analyse sur $TARGET_URL"
          python3 << 'EOF'
          from zapv2 import ZAPv2
          import time

          target = '${{ github.event.inputs.target_url }}'
          zap = ZAPv2(proxies={'http': 'http://localhost:8090', 'https': 'http://localhost:8090'})

          print("ğŸ“¡ Scan en cours sur :", target)
          zap.urlopen(target)
          time.sleep(5)

          print("âš™ï¸ Lancement du scan actif...")
          scan_id = zap.ascan.scan(target)
          while int(zap.ascan.status(scan_id)) < 100:
              print("â³ Progression:", zap.ascan.status(scan_id), "%")
              time.sleep(10)

          print("âœ… Scan terminÃ©. GÃ©nÃ©ration des rapports...")

          with open('zap_report.html', 'w', encoding='utf-8') as f:
              f.write(zap.core.htmlreport())

          with open('zap_report.json', 'w', encoding='utf-8') as f:
              f.write(zap.core.jsonreport())

          print("ğŸ“„ Rapports gÃ©nÃ©rÃ©s : zap_report.html / zap_report.json")
          EOF

      - name: ğŸ“¤ Upload du rapport HTML
        uses: actions/upload-artifact@v4
        with:
          name: ZAP_Report_HTML
          path: zap_report.html
          retention-days: 30

      - name: ğŸ“¤ Upload du rapport JSON
        uses: actions/upload-artifact@v4
        with:
          name: ZAP_Report_JSON
          path: zap_report.json
          retention-days: 30
