name: Analyse automatique OWASP ZAP

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    name: Scan de sÃ©curitÃ© avec OWASP ZAP
    
    steps:
      # Ã‰tape 1 : RÃ©cupÃ©ration du code
      - name: ğŸ§© Checkout du dÃ©pÃ´t
        uses: actions/checkout@v4

      # Ã‰tape 2 : Configuration de Python
      - name: ğŸ Configuration de Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      # Ã‰tape 3 : Installation des dÃ©pendances
      - name: ğŸ“¦ Installation des dÃ©pendances
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "âš ï¸ Aucun fichier requirements.txt trouvÃ©"
          fi

      # Ã‰tape 4 : DÃ©marrage de l'application Flask
      - name: ğŸš€ DÃ©marrage du serveur Flask
        run: |
          echo "ğŸ”§ DÃ©marrage de l'application Flask..."
          nohup python3 app.py > flask_server.log 2>&1 &
          SERVER_PID=$!
          echo "ğŸ“ PID du serveur: $SERVER_PID"
          echo $SERVER_PID > server.pid
          
          # Attendre que le serveur dÃ©marre (max 30 secondes)
          echo "â³ Attente du dÃ©marrage du serveur..."
          for i in {1..30}; do
            if curl -s http://127.0.0.1:5000 > /dev/null 2>&1; then
              echo "âœ… Serveur Flask opÃ©rationnel aprÃ¨s $i secondes"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ Le serveur Flask n'a pas dÃ©marrÃ© dans les temps"
              echo "ğŸ“‹ Logs du serveur:"
              cat flask_server.log
              exit 1
            fi
            sleep 1
          done
          
          # VÃ©rification finale
          echo "ğŸ” Test de connectivitÃ©:"
          curl -I http://127.0.0.1:5000

      # Ã‰tape 5 : CrÃ©ation du dossier pour les rapports
      - name: ğŸ“ CrÃ©ation du dossier de rapports
        run: |
          mkdir -p ${{ github.workspace }}/zap-reports
          chmod 777 ${{ github.workspace }}/zap-reports

      # Ã‰tape 6 : ExÃ©cution du scan OWASP ZAP
      - name: ğŸ•·ï¸ Scan OWASP ZAP Baseline
        run: |
          echo "ğŸš€ Lancement de l'analyse OWASP ZAP..."
          docker run --rm \
            --network host \
            -v ${{ github.workspace }}/zap-reports:/zap/wrk:rw \
            -u root \
            owasp/zap2docker-stable \
            zap-baseline.py \
            -t http://127.0.0.1:5000 \
            -r rapport_zap.html \
            -w rapport_zap.md \
            -J rapport_zap.json \
            -a \
            -d \
            -I \
            || true
          
          echo "âœ… Scan ZAP terminÃ©"
        continue-on-error: true

      # Ã‰tape 7 : VÃ©rification de la gÃ©nÃ©ration des rapports
      - name: ğŸ” VÃ©rification des rapports gÃ©nÃ©rÃ©s
        if: always()
        run: |
          echo "ğŸ“‹ Contenu du dossier zap-reports:"
          ls -lah ${{ github.workspace }}/zap-reports/
          
          if [ -f "${{ github.workspace }}/zap-reports/rapport_zap.html" ]; then
            echo "âœ… Rapport HTML gÃ©nÃ©rÃ© avec succÃ¨s"
            SIZE=$(stat -f%z "${{ github.workspace }}/zap-reports/rapport_zap.html" 2>/dev/null || stat -c%s "${{ github.workspace }}/zap-reports/rapport_zap.html")
            echo "ğŸ“ Taille du rapport: $SIZE octets"
          else
            echo "âš ï¸ Rapport HTML non trouvÃ©"
          fi

      # Ã‰tape 8 : Affichage d'un rÃ©sumÃ© du scan
      - name: ğŸ“Š RÃ©sumÃ© du scan
        if: always()
        run: |
          if [ -f "${{ github.workspace }}/zap-reports/rapport_zap.md" ]; then
            echo "ğŸ“„ RÃ©sumÃ© du rapport ZAP:"
            cat ${{ github.workspace }}/zap-reports/rapport_zap.md
          else
            echo "âš ï¸ Rapport Markdown non disponible"
          fi

      # Ã‰tape 9 : Analyse JSON pour compter les vulnÃ©rabilitÃ©s
      - name: ğŸ”¢ Analyse des vulnÃ©rabilitÃ©s dÃ©tectÃ©es
        if: always()
        run: |
          if [ -f "${{ github.workspace }}/zap-reports/rapport_zap.json" ]; then
            echo "ğŸ” Analyse du rapport JSON..."
            
            # Installation de jq si nÃ©cessaire
            sudo apt-get install -y jq
            
            # Comptage des alertes
            HIGH=$(jq '[.site[].alerts[]? | select(.riskcode=="3")] | length' ${{ github.workspace }}/zap-reports/rapport_zap.json || echo "0")
            MEDIUM=$(jq '[.site[].alerts[]? | select(.riskcode=="2")] | length' ${{ github.workspace }}/zap-reports/rapport_zap.json || echo "0")
            LOW=$(jq '[.site[].alerts[]? | select(.riskcode=="1")] | length' ${{ github.workspace }}/zap-reports/rapport_zap.json || echo "0")
            INFO=$(jq '[.site[].alerts[]? | select(.riskcode=="0")] | length' ${{ github.workspace }}/zap-reports/rapport_zap.json || echo "0")
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“Š RÃ‰SULTATS DU SCAN OWASP ZAP"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ”´ VulnÃ©rabilitÃ©s HIGH   : $HIGH"
            echo "ğŸŸ  VulnÃ©rabilitÃ©s MEDIUM : $MEDIUM"
            echo "ğŸŸ¡ VulnÃ©rabilitÃ©s LOW    : $LOW"
            echo "ğŸ”µ Informations          : $INFO"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Optionnel : Faire Ã©chouer si des vulnÃ©rabilitÃ©s critiques sont trouvÃ©es
            # DÃ©commentez les lignes suivantes si vous voulez bloquer le pipeline
            # if [ "$HIGH" -gt "0" ]; then
            #   echo "âŒ Ã‰CHEC: $HIGH vulnÃ©rabilitÃ©s HIGH dÃ©tectÃ©es!"
            #   exit 1
            # fi
          else
            echo "âš ï¸ Rapport JSON non disponible pour l'analyse"
          fi

      # Ã‰tape 10 : Upload des rapports en tant qu'artifacts
      - name: ğŸ“¤ Upload des rapports ZAP
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rapport-zap-${{ github.run_number }}
          path: |
            ${{ github.workspace }}/zap-reports/
            flask_server.log
          retention-days: 30

      # Ã‰tape 11 : Affichage des logs du serveur Flask
      - name: ğŸ“‹ Logs du serveur Flask
        if: always()
        run: |
          echo "ğŸ“‹ Logs du serveur Flask:"
          if [ -f flask_server.log ]; then
            cat flask_server.log
          else
            echo "âš ï¸ Fichier de logs non trouvÃ©"
          fi

      # Ã‰tape 12 : Nettoyage - ArrÃªt du serveur Flask
      - name: ğŸ§¹ ArrÃªt du serveur Flask
        if: always()
        run: |
          if [ -f server.pid ]; then
            PID=$(cat server.pid)
            echo "ğŸ›‘ ArrÃªt du serveur Flask (PID: $PID)..."
            kill $PID 2>/dev/null || echo "âš ï¸ Processus dÃ©jÃ  arrÃªtÃ©"
          fi
          # Nettoyage de tous les processus Python restants
          pkill -f "python3 app.py" || true
          echo "âœ… Nettoyage terminÃ©"
