name: Analyse OWASP ZAP automatique (Docker)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§© Checkout
        uses: actions/checkout@v4

      - name: âš™ï¸ Installer dÃ©pendances Python
        run: |
          sudo apt update -y
          sudo apt install -y python3 python3-pip curl
          pip install -r requirements.txt || true

      - name: ğŸš€ Lancer l'application Flask en arriÃ¨re-plan
        run: |
          nohup python3 app.py > server.log 2>&1 &
          echo "â³ DÃ©marrage du serveur Flask..."
          for i in {1..20}; do
            if curl -sSf http://127.0.0.1:5000 >/dev/null 2>&1; then
              echo "âœ… Serveur Flask OK"
              break
            else
              echo "ğŸ”„ En attente du serveur Flask..."
              sleep 3
            fi
          done
          echo "---- logs serveur (10 derniÃ¨res lignes) ----"
          tail -n 10 server.log || true

      - name: ğŸ³ Scanner avec OWASP ZAP (docker image)
        # utilise le rÃ©seau host pour que le container voit http://127.0.0.1:5000 du runner
        run: |
          echo "ğŸ” Lancement du scan ZAP via docker (owasp/zap2docker-stable)"
          docker run --rm --network host -v "${{ github.workspace }}:/zap/wrk" owasp/zap2docker-stable \
            zap-baseline.py -t http://127.0.0.1:5000 -r /zap/wrk/rapport_zap.html -l INFO || true
          echo "---- Contenu du workspace aprÃ¨s scan ----"
          ls -la "${{ github.workspace }}" | sed -n '1,200p'

      - name: ğŸ“‚ VÃ©rifier le rapport
        if: always()
        run: |
          if [ -f "./rapport_zap.html" ]; then
            echo "âœ… rapport_zap.html trouvÃ©"
            ls -lh rapport_zap.html
          else
            echo "âŒ rapport_zap.html introuvable â€” affichage du dossier courant :"
            pwd; ls -la
            exit 1
          fi

      - name: ğŸ“¦ Upload artifact (rapport OWASP ZAP)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rapport-owasp-zap
          path: rapport_zap.html
