name: OWASP_ZAP_DAST

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      target_url:
        description: "Entrez l'URL cible √† analyser"
        required: true
        default: "http://127.0.0.1:5000"

env:
  TARGET_URL: ${{ github.event.inputs.target_url }}

jobs:
  zap_dast:
    runs-on: ubuntu-latest

    steps:
      - name: üì• R√©cup√©ration du code source
        uses: actions/checkout@v4

      - name: üêç Installation de Python et d√©pendances Flask
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - run: |
          pip install -r requirements.txt || true
          nohup python3 app.py > flask_server.log 2>&1 &
          echo "‚è≥ D√©marrage du serveur Flask..."
          for i in {1..15}; do
            if curl -sSf http://127.0.0.1:5000 >/dev/null 2>&1; then
              echo "‚úÖ Flask est pr√™t !"
              break
            else
              echo "üîÑ En attente..."
              sleep 3
            fi
          done

      - name: üì¶ Installation OWASP ZAP
        run: |
          sudo apt update -y
          sudo apt install -y wget openjdk-17-jre-headless
          wget https://github.com/zaproxy/zaproxy/releases/download/v2.15.0/ZAP_2.15.0_Linux.tar.gz
          tar -xvf ZAP_2.15.0_Linux.tar.gz
          ./ZAP_2.15.0/zap.sh -daemon -host 0.0.0.0 -port 8090 -config api.disablekey=true &
          echo "‚è≥ Lancement du daemon ZAP..."
          sleep 25

      - name: ‚ö° Ex√©cution du scan OWASP ZAP
        run: |
          ./ZAP_2.15.0/zap-cli --api-key "" status -t 120 || true
          ./ZAP_2.15.0/zap-cli --api-key "" quick-scan --self-contained --spider --scanners all $TARGET_URL || true
          ./ZAP_2.15.0/zap-cli --api-key "" report -o zap_report.html -f html
          ./ZAP_2.15.0/zap-cli --api-key "" report -o zap_report.json -f json

      - name: üìÇ Upload du rapport HTML
        uses: actions/upload-artifact@v4
        with:
          name: Rapport_OWASP_ZAP_HTML
          path: zap_report.html
          retention-days: 30

      - name: üìÇ Upload du rapport JSON
        uses: actions/upload-artifact@v4
        with:
          name: Rapport_OWASP_ZAP_JSON
          path: zap_report.json
          retention-days: 30
