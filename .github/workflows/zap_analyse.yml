name: Analyse OWASP ZAP automatique

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  zap_scan:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© VÃ©rification du dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: âš™ï¸ Installation Python et dÃ©pendances
        run: |
          sudo apt update -y
          sudo apt install -y python3 python3-pip wget unzip openjdk-17-jre-headless
          pip install -r requirements.txt

      - name: ğŸš€ Lancement du serveur Flask en arriÃ¨re-plan
        run: |
          nohup python3 app.py > server.log 2>&1 &
          echo "â³ DÃ©marrage du serveur Flask..."
          # Attente jusquâ€™Ã  ce que Flask rÃ©ponde
          for i in {1..20}; do
            if curl -s http://127.0.0.1:5000 > /dev/null; then
              echo "âœ… Serveur Flask en ligne."
              break
            else
              echo "ğŸ”„ En attente du serveur Flask..."
              sleep 5
            fi
          done

      - name: ğŸ“¥ TÃ©lÃ©chargement et extraction de OWASP ZAP
        run: |
          wget https://github.com/zaproxy/zaproxy/releases/download/v2.14.0/ZAP_2_14_0_unix.zip
          unzip ZAP_2_14_0_unix.zip -d zap
          chmod +x zap/ZAP_2.14.0/zap.sh

      - name: ğŸ•·ï¸ ExÃ©cution du scan OWASP ZAP (mode headless)
        run: |
          cd zap/ZAP_2.14.0
          echo "ğŸš€ Lancement de ZAP scan sur http://127.0.0.1:5000"
          ./zap.sh -cmd \
            -quickurl http://127.0.0.1:5000 \
            -quickout ../../rapport_zap.html \
            -quickprogress \
            -addonupdate \
            -silent || echo "âš ï¸ ZAP a retournÃ© une erreur (non bloquante)."
        continue-on-error: true

      - name: ğŸ“‚ VÃ©rification du rapport gÃ©nÃ©rÃ©
        if: always()
        run: |
          if [ -f rapport_zap.html ]; then
            echo "âœ… Rapport OWASP ZAP gÃ©nÃ©rÃ© avec succÃ¨s."
          else
            echo "âŒ Rapport ZAP introuvable, vÃ©rifie la configuration."
            ls -la
          fi

      - name: ğŸ“¦ Sauvegarde du rapport OWASP ZAP
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rapport-owasp-zap
          path: rapport_zap.html
